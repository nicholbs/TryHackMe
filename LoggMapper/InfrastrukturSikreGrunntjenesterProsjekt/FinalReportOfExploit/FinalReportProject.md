Pentesting microsoft domain with excessive user rights
======================================================

**Author**: Nicholas Bodvin SellevÃ¥g  
**Date**: submitted 02/05/2020  
**Version**: 3.0  
**GitHub**: [Report-markdown](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/FinalReportProject.md)  
**Environment**: [Kali](https://www.kali.org/)  
**Tools used**: [Metasploit](https://www.metasploit.com/)  
 
 
 
Misimplementation of active directory domain services
-------------------------------------------------------------------
**Abstract**  

This report outlines weaknesses exposed with excessive user rights on a windows domain, and subsequently the lack of active directory domain services configuration.  
Remote attacker are enabled access through buffer overflow and lack of security configurations.  
Means and meassures of attackers, in addition to procedures for recovery are described in details.   


**Table of Contents**  
1. Purpose of report  
2. Exploited vulnerability  
  2.1 Current infrastructure and services
  2.1 Buffer overflow 
3. Attack  
  3.1 Recon/Auxilliary 
  3.2 Gain Access  
  3.3 Escalate  
  3.4 Post-Exploitation and Looting  
4. Recovery procedures  
  4.1 Identify the problem 
  4.2 Being rooted  
  4.3 Recover control
  
  
1.Purpose of report  
--------------------
The windows infrastructure component Active directory Certificate Services will be proven vulnerable to exessive user rights. 

Report outlines how excessive user rights constitute foothold for attackers to exploit a windows infrastructure.  
Readers will alltogether learn the importance of exercising appropriate group policies for users.  
Furthermore, attackers methodology is bestoved focus to demonstrate the mentality needed  
from administrator when implementing security systems in their network.  

Exploits explored in this report are all available in the metasploit framework.  
Moreover, Metasploit consists of scripts, modules, interfaces and libraries assembled together into a single framework.  
The framework serves as an ease of access tool for penetration testing networks, proficiency in computer systems is not required.  
This report will only use tools obtainable through metasploit.  
With this in mind, one could argue that any user pose a security threat and should be given rights accordingly.  

2.Exploited vulnerability 
=======================  

2.1 Current infrastructure and services  
---------------------------------------  
The scenario consists of a radio streaming business.  
Local clients use the application Icecast for publishing their audio online.
Remote listeners connects to locally hosted web addresses, typically on a web browser.
Icecast can be applied to most unix and windows opperating systems, and it is notewhorty that the application does not produce audio.  
  
Third party software is necessary to feed sound into Icecast. Supplementary software for audio feed is accessible on any operating system.  
Consequently exploiting Icecast affects all broadcasters in our scenario, there are no limitations based on operating systems.  

The infrastructure itself reflects a medium sized business in size and consists of hosts connected into a windows domain with active directory domain services.  
It is notewhorty that neither size or type of computer is a determining factor for this scenario seing as any client or server running Icecast is affected.  
Subsequently, future examples of the infrastructure revolve around a single host.  

 2.1 Buffer overflow
 -------------------
Specifically, Icecast version 2.0.1 and earlier installements are vulnerable to buffer overflow.  
Buffer overflow is a central concept to avoid when creating sturdy and reliable code.
Programs that run without proper measurements against overflowing buffers from user input can result in execution of malicious code on hosts.
In other words, explaining the concept of buffer overflow is vital for understanding the ensuing vulnerabilities.
After all, understanding the problem is essential before applying solutions.  

>"No problem can be solved from the same level of consciousness that created it." -Albert Einstein  

Imagine pouring water into a glass, it soon reaches the brim. The glass is entirely full and has reached its limits.
Then pour some additional water and water overflows.  
In a similar fashion programs without proper boundaries can overflow buffers.  
Buffers are an allocated memory block of specified lenght.  
Superceeding the manageable amount of data results in extra data overwriting critical values. 

To understand the concept of buffer overflow, following chapters makes an attempt at explaining:
1. Usage of buffers in coding
2. Memory addresses spaces.
3. Leak in memory

*Usage of buffers in coding*  
The regularity of buffer overflow differ from programming languages and the environment code is written in.  
Programs written in C are often associated with buffer overflow.  
Games tends to be developed with languages of similar features as they offers faster compiling time and execution with optimization.  
Furthermore values on security and reliability in such environments are often sacrificed for speed.  
Input from users is gathered with functions such as scanf, gets and strcpy.  
The less boundary checking, the more compiling speed.  
No matter the circumstances, absence of bounds-checking ultimately results in buffer overflow.  

All programs that ask for input has some way or form of buffer tied into the process. 
Users can be prompted to input their names. Behind the scenes the program was made with the expectation that no name contains more than 20 characters.  
Writing "John Smith" meets the boundaries for the program and it is able to run along successfully.  
Write "John Smithhhhhhhhhhhhhhhhh" and suddenly the buffer has overflown with all extra "h" overwriting the next memory address.

*Memory address spaces*  
Programs are given access to memory during runtime and becomes a process.  
The memory can be viewed as blocks, within are address spaces stacked together to form the block.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Allocated%20memory.PNG" width="400" height="230">  

Essentially, code is compiled from human programming language into machine code and mapped into each address space.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Address%20space.PNG" width="400" height="230">  

Processes load addresses to serve a function inside the program.  
To conclude, memory adress is assigned to a process and contains code to be loaded and run by programs.  

*Leak in memory*  
Programs use functions to achieve tasks and require some form of computing handled by the CPU.  
The address of memory to be computed is sent to the CPU and considered instructions.  
There are different types of storage for instruction in the CPU called registers.  
To remain on topic, only the vulnerability concept will be explained and not the structure of registers.  

The CPU handles an instruction at a time, in which it uses pointers to deliminate which instruction to be handled in order. 
Extended Stack pointer (ESP) keeps track of what memory address is the current instruction.  
Extended Instruction Pointer (EIP) keeps track of what memory address is the succedding instruction.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Instructions.PNG" width="400" height="230">  

Conclusively, we are able to address the vulnerability being exploited, namely overwriting the pointed address.  
For example, the current instruction pointed by the ESP is a buffer.
The buffer was an allocated space for input from user to be contained.  
User exceeds the boundaries with its input and overflows into next address space, which overwrites the address pointed by EIP.  
In extent, the user has created a new pointed address which resulted on seperate code being run and executed.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/CPU%20register.PNG" width="400" height="230">  
Overwriting could lead to processes loading malicious code, some opens powershell and execute cmdlets.  

The general explanation for buffer overflow applies to several exploits. This report has emphasis on its usage thowards Icecast.  
Linked is a transcript of Luigi Auriemma's report for buffer overflow vulnerability on Icecast.  
[Luigi Auriemma's report!](https://www.exploit-db.com/exploits/568)  

3.Attack  
========
Cybersecurity is a tug of war between attackers and defender.  
Both sides has respective weaknesses and strenghts and the element of surprise is perhaps the attackers foremost advantage.  
In the scenario at hand there are multiple possibilities for attackers to gain knowledge about the broadcasting service's network.  
The broadcasting service is a business and naturally advertise their services on the internet.    
Another method for finding potential targets is picking an ISP and carry out a domain based search to determine their associated IP address block. 
This is the auxilliary phase in which attackers gain knowledge prior to directly exploiting vulnerabilities.  

Tools and methods presented are opensource and easily available for users without hacking background. 

3.1 Recon/Auxilliary  
--------------------
Nmap is a commonly used network mapping tool. There are numerous functionalities inside nmap which is used to discover hosts and affiliated services.  
Network packaged are sent and the returning answers, or lack of, are used to detemine what circumstances produce the packages received on the target host.  
Furthermore, Nmap generate reports based on percentage for possible conditions and environments the scanned host are in.  
In regards to retaining the element of surprise, attackers scan the target's network and gradually increasing the leverage used behind each sweep.  
For example TCP packages can initially be sent as SYN messages which only completes half of the TCP handshake. Target will answer with reset as it has no knowledge of the connection and usually do not logg the occurrence.   
[Nmap-SYN-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-SynScan)  

It is notewhorty that routers and hosts usually are configured to not answer unestablished connections.  
The leverage on attacks increases as the "-A" option is flagged and nmap performs an aggressive scanning of the target.  
Experienced attackers will refrain from using predefined scripts and methods, despite this our report illustrates that any user can be capable of launching such attacks.  
[Nmap-Agressive-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-AggressiveScan)  
[Nmap-Vulnerability-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-VulnScan.PNG)  

Nmap reports that the target is likely vulnerable to ms-17_010, Namely the vulnerability EternalBlue used in WannaCry.  
In addition, nmap was also able to conclude that port 8000 is associated with Icecast services.  
Either exploit serves as an entry point, and the focus remains on exploiting Icecast.

3.2 Gain Access  
---------------  
Metasploit is a framework to penetration test networks. For instance, Metasploit comes with nmap and a vast amount of modules to run against targets. The framework can be summarized with the following model provided by [Varonis blogg post](https://www.varonis.com/blog/what-is-metasploit/)  

[Metasploit-Logg](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Metasploit-Spool)  


<img src="https://blogvaronis2.wpengine.com/wp-content/uploads/2019/08/metasploit-guide-benefits.png" width="420" height="300">  

 
Metasploit uses same script as first reported by [Luigi Auriemma](https://www.exploit-db.com/exploits/568) and is runnable after defining RHOST parameter to targeted host.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/IcecastExploitRun.PNG" width="620" height="150">  

Icecast script can be summarized into four stages:  
1. Use buffer overflow and point to malicious code.  
2. Malicious code installs Netcat or similar software on remote target meanwhile a local listener awaits connection from target.
3. Netcat establishes TCP session with attacker from target.
4. Newly created session is established with meterpreter shell.  

Buffer overflow as explained previously is used to execute malicious code which installs Netcat.  
Attemps are made to initiate TCP connection back to the attacker, in our case there is a listener on port 4444.  
After successfully establishing a session to listener from target the meterpreter acts as payload. Meterpreter is injected into the targets memory and serves as a "shell" which can load extensions from Metasploit.  
Meterpreter is out of scope for this report. Nevertheless, meterpreter residing in memory is important as nothing is written to disks and therefore becomes difficult to trace by defenders.  

3.3 Escalate  
------------  
Meterpreter aswell as other payloads have corresponding rights to the processes they reside in.  
If the ultimate goal for an attacker is achieving administrative rights, meterpreter needs to migrate into processes run by an administrator or user of escalated rights.  
Another aspect of migrating comes from the possibility of loosing access to target host.  
If the process meterpreter inhabit is terminated, connection between attacker and target ceases.  
Migrating to a process with elevates rights and which is stable is therefore vital for the attacker.  
The targeted network posessed little to none security measures prohibiting unwanted users initial access.  
In spite of this, attacker is prohibited from migrating between prosesses and entering files in view of active directory certificate services and Windows UAC (User account Control) requiring authentication.  

Exploits revealed thus far on the radio network are Icecast and EternalBlue. Updated software is available to hinder buffer overflow for Icecast, and SMBv1 protocol is outdated which enables EternalBlue attacks.  
Considering that neither exploits should have been accessible for the attacker, it may be concluded that the implementation of active directory right management services and group policies was flawed and insufficient.  
To encapsulate the aforementioned statements into the running theme of this report, the component of windows infrastructe that is made vulnerable is certificate and authentication servises. 

Authentication is generally handled in two manners from an attackers standpoint. To illustrate one could imagine a locked door blocking entrance into a house. Depending on the door's strenght and sturdy quality attackers might be refrained from attempting further access.
On the other hand, with enough brute force an attacker will manage to breach. Methods that apply brute force are noisy and can develop into other problems.  
Prefferably, an attacker want to remain undetected and circumvent the door altogether through a window.  
Continuing from the attacker's perspective, the current obstacle is UAC which mainly prohibits programs from running tasks that perform changes to the system.  
Essentially, processes are tagged with a UAC flag that require authentication to run task which affects the system. The current meterpreter session have equivalent rights to the process's user, namely "Dark", and brute forcing with every bit of information available through the user is always an option.  
Despite this, there are modules in Metasploit for bypassing UAC impeded processes.
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Escalating.PNG" width="650" height="290">  

Module is able to create a new shell from the opening of eventviewer through changing attributes and values of stored keys. Multiple steps are taken afterwards by the same module to leave the system in a similar state before doing system changes. New shell, unaffected by UAC, allows meterpreter to migrate into another process. Processes that are stable and inherit elevated rights have not been difficult to discover while researching for the project.   
In fact, printing involves a process called "spoolsv" which interacts with printers and often maintain elevated rights.  

3.4 Post-Exploitation and looting  
---------------------------------  

Host is at this point fully compromised and attackers migrated into a process from "NT AUTHORITY".  
Comparatively, administrator accounts are below "NT AUTHORITY" in privilege.  
Post modules in Metasploit are applied to host and retrieves all of its credentials rendering certification of users futile.  

<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Creds_all.PNG" width="600" height="500">  
   
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Hashdump.PNG" width="600" height="80">  

The host is also converted into a monitoring device for the attacker as access to camera, audio devices, and desktop screen can record the near surroundings of exploited computer.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/ScreenshotOfTarget.jpeg" width="340" height="320">  

In spite of the circumstances, the remaining network is not necessarily contaminated. Active directory can still have restraints between different nodes in network.  
For example kerberos is part of authenticating both users and computers with its ticket granting services. 
ALthough the report could continue with leverage on modules inside Metasploit for obtaining a "Golden Ticket", the purpose of the report has been achieved and report fundings does not support further elaboration.

Excessive user rights has been proved through examples to constitute foothold for attackers to exploit a windows infrastructure. 
Foremost, excessive user privilege reflects a flawn implementation of active directory right management services and group policies which enabled the attacker to exploit Icecast and possibly EternalBlue.  
As a consequence of the exploitable services, windows infrastructure Active Directory Domain Services and Certificate Services components became vulnerable. 


4.Recovery procedures 
=====================
Report has primarily been presented through the perspective of a silent attacker. While retaining the element of surprise defenders was not able to limit attacker's access and was left with a completely exposed system.  
The course of action following an infiltrations is refferenced to as "Recovery procedures" and entails defenders patching weaknesses exposed and implementing alleviating technologies.  

4.1 Identify the problem  
------------------------
Symptoms of a system breached through Icecast vulnerabilities can be found in:
1. Microsoft error message (pop up windows)
2. Microsoft Eventviewer
3. Netcat

Icecast will forcefully close on the client which is streaming.  
The generated pop upp error message describes Icecast encountering a problem.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/Icecast%20error%20message.PNG" width="400" height="230">  
Users would need to be physically present for an error to be reported.  
Furthermore, there are time margins for the breach being reported before attacker has hidden his presence.  

Microsoft Eventviewer is more likely to be noticed by defenders.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/Microsoft%20Eventviewer.PNG" width="300" height="300">  
Eventviewer produces error message and specifically mentions the EIP pointer that was affected by buffer overflow.  

Breached hosts can be recognized with traces of netcat.  
Capturing packets inside the network would reveal instalement of netcat on host.  
Another sign is physical instances of netcat processes on host.  
For instance the process can be viewed through task manager and Eventviewer.  

4.2 Being rooted  
----------------
Systems exposed to intruders with higher privilege remain vulnerable until reloading the operating system.  
Being rooted entails that attackers have access to the entirety of a host and could likewise leave doors hanging on their way out.  
The first course of action no matter what is to contain hosts affected and remove them from internett.
Personal data should be taken as backup, but it is important to handle every single piece of the exposed system as a threat.  
All in all, formatting drives and reloading operating system leaves nothing to be uncertain of.

Involve law enforcement and document the actions that led to the compromised system being discovered.
Duplicate hard drives on exposed systems and assemble them together as evidence.  
Deliver the physical evidence in addition to all documentation of the accident to forensic analysis. It is vital that access to the evidence has been limited before changing custody.   

4.3 Recover control  
-------------------
Systems are only as secure as their weakest link.  
With this in mind, how could one secure the network from similar future occurences?  

Users needs to be aware of business guidelines. The weakest link of a system is often the person using it, and with the correct guidance people can become adaptive. Group policies on a network are static and not able to analyse and create new guidelines based on information presented, a human on the other hand is capable of applying guidelines in new cases. It is notewhorty that passwords culture still favors attackers in them being easy to guess and hard to remember. Users should always be a main concern when administering a network. 

Pressure from each host spread out on the network can be allevated with a centralized router. Controlling what information is allowed into the domain to begin with is a powerfull tool, specifically a selected few ports and channels made availablr narrows the playing field for attackers. In the case of aforementioned but unexplored exploit EternalBlue, it is not uncommon for networks to block remote usage of file protocols which renders the exploit useless when facing such a roter. 

Core services should be seperated. Multiple domains can achieve a logical seperation between hosts and enables relation based trust to be built from.  
Secondary and core hosts seperated by onesided domain trusts minimizes impact on business in the case of breaches. Multiple domains 
makes the network flexible in having different configurations based on the domain's needs.

All in all, the primary solutions for mitigating similar future exploits are configurable inside or enhanced by Active Directory Domain Services. The exploit became available as a combined result of bad practice network administration and outdated software. Users could in that sence have strict policies prohibition usage of software to the secure and appointed necessary services, in addition to enforce update policies released from puppet servers and domain controllers. Lastly, there are always room for antivirus software in a network. Not having mentioned antivirus until the very last is a subconscious decision seeing as it is far less likely to be the intruder diminishing factor in contrast to propper configuration of network nodes and having updated computers. Furthermore, viruses becomes more and more complex and takes advantage of volatile memory to avoid writing to files which is the primary method for antivirus software to detect malware. 
    
Sources
=======

[Metasploit-Modules-Model-Picture-Source](https://blogvaronis2.wpengine.com/wp-content/uploads/2019/08/metasploit-guide-benefits.png)

[Microsoft-EventViewer-Picture-Source](https://pen-testing.sans.org/resources/papers/gcih/remote-exploitation-icecast-201-server-106910?fbclid=IwAR0E8R5HZkBZ4EjDoxowaQzDOeu4tvgqtbB6sRHdlfhgxibt2PekefM-xks)

[Icecast-ErrorMessage-Source](https://pen-testing.sans.org/resources/papers/gcih/remote-exploitation-icecast-201-server-106910?fbclid=IwAR0E8R5HZkBZ4EjDoxowaQzDOeu4tvgqtbB6sRHdlfhgxibt2PekefM-xks)

[Albert-Einstein-Quote-Source](https://www.goodreads.com/quotes/806696-no-problem-can-be-solved-from-the-same-level-of)


Appendix
========


[Powershell-ReportConvertedToHtml-Script](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/ScriptForRapport.ps1)  

[Powershell-HtmReportl-PDF](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/Html-Report.pdf)  
   
   
[Powershell-SendGitHubInfo-Script](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/SendeGitLabScript.ps1) 
