Pentesting microsoft domain with excessive user rights
======================================================

**Author**: Nicholas Bodvin SellevÃ¥g  
**Date**: submitted 01/05/2020  
**Version**: 2.0  


Misimplementation of active directory domain services
-------------------------------------------------------------------
**Abstract**  

This report outlines weaknesses exposed in excessive user rights on a windows 2000 computer, and subsequently the lack of active directory domain services configuration.  
Remote attacker was enabled access through buffer overflow and lack of security configurations.  
Means and meassures of attacks and procedures for recovery are described in details.   


**Table of Contents**  
1. Purpose of report  
2. Exploited application  
  2.1 Current infrastructure and services
  2.1 Buffer overflow 
3.  Attack  
    3.1 Recon/Auxilliary  
    3.1 Nmap
  3.2 Gain Access  
    3.2 Buffer overflow  
    3.2 Reverse TCP /gaining shell  
  3.3 Escalate  
    3.3 meterpreter  
  3.4 Cracking the hash  
    3.4 Brute force / John the ripper  
  3.5 Looting  
    3.5 lack of security configurations  
    3.5 Exposing users / Minikatz (Kiwi) creds all  
  3.6 Post-Exploitation  
    3.6 hashdump, screenshare, record mic, golden ticket  
4.Recovery procedures  
  4.1 Identify the problem 
  4.2 Being rooted  
  4.3 Recover control  
  4.4 Prospects of active directory  
  
  
1.Purpose of report  
--------------------
The report outlines how excessive user rights constitute foothold    
for attackers to exploit a windows infrastructure.  
Readers will alltogether learn the importance of exercising appropriate group policies for users.  
Furthermore the attackers methodology is bestoved focus to demonstrate the mentality needed  
from administrator when implementing security systems in their network.  

Exploits explored in this report are all available in the metasploit framework.  
Moreover, Metasploit consists of scripts assembled together into a single framework.  
The framework serves as an ease of access tool for penetration testing networks, proficiency in computer systems is not required.  
This report will only use tools obtainable through metasploit.  
With this in mind, one could argue that any user pose a security threat and should be given rights accordingly.  

2.Exploited application  
=======================  

2.1 Current infrastructure and services  
---------------------------------------  
The scenario consists of a radio streaming business.  
Local clients use the application Icecast for publishing their audio online.
Remote listeners connects to locally hosted web addresses, typically on a web browser.
Icecast can be applied to most unix and windows opperating systems, and it is notewhorty that the application does not produce audio.  
  
Third party software is necessary to feed sound into Icecast.  
Supplementary audio software is accessible on any operating system.  
Consequently exploiting Icecast affects all broadcasters in our scenario, there are no limitations based on operating systems.  

The infrastructure itself reflects a medium sized business in size, and has implemented their domain with active directory domain services.  
It is notewhorty that neither size or type of computer is a determining factor for this scenario seing as any client or server running Icecast is affected.  
For ease of concept, future examples will represent the whole domain with only a single client and domain controller.  

 2.1 Buffer overflow
 -------------------
Specifically, Icecast version 2.0.1 and earlier installements are vulnerable to buffer overflow.  
Buffer overflow is a central concept to avoid when creating sturdy and reliable code.
Programs that run without proper measurements to overflowing buffers can lead to the exploits this report entails.
In other words, explaining buffer overflow is vital for the report and leading pharagraps will make an attempt at it. 
After all, understanding the problem is essential before applying solutions.  

>"No problem can be solved from the same level of consciousness that created it." -Albert Einstein  

Imagine pouring yourself a glass of water, naturally there is a limit without leaking.  
Then pour some additional water and the glass overflows.  
In the same manor some programs without proper boundaries can overflow buffers.  
Buffers are an allocated memory block of specified lenght.  
Superceeding the manageable amount of data results in the extra data overwriting critical values. 

To fully understand the concept of buffer overflow, three aspects are necessary:
1. Usage of buffers in coding
2. Memory addresses spaces.
3. Leak in memory

*Usage of buffers in coding*  
The regularity of buffer overflow differ from programming languages.  
Programs written in C is often associated with buffer overflow.  
For example, games are often developed with C as it can offers faster compiling time and execution.  
Furthermore values on security and reliability in such environments are often sacrificed for speed.  
Input from users is gathered with functions such as scanf, gets and strcpy.  
Absence of appropriate boundary checking when receiving input can result in buffer overflow.  

In fact every program that asks for credentials have a similar input function.  
Behind the scenes a user can be expected to input their name with 20 characters.  
Write "John Smith" and the boundaries are met.  
Write "John Smithhhhhhhhhhhhhhhhh" and suddenly the buffer has overflown and all extra "h" will affect the next memory address.

*Memory address spaces*  
Programs are given access to memory during runtime and becomes a process.  
The memory can be viewed as blocks, within are address spaces stacked together to form the block.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Allocated%20memory.PNG" width="400" height="230">  

Essentially, code is compiled from human programming language into machine code and mapped into each address space.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Address%20space.PNG" width="400" height="230">  

Processes load addresses to serve a function inside the program.  
To conclude, memory adresses spaces are assigned to a process and contains code to be loaded and run by programs.  

*Leak in memory*  
Functions inside require some form of computing that is handled by the CPU.  
The address of memory to be computed is sent to the CPU and considered instructions.  
There are different types of storage for instruction in the CPU called registers.  
To remain on topic, only the vulnerability concept will be explained and not registers structure.

The CPU handles an instruction at a time, in which it uses pointers to deliminate which instruction to be handled.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/Instructions.PNG" width="400" height="230">  
Extended Stack pointer (ESP) keeps track of what memory address is the current instruction.  
Extended Instruction Pointer (EIP) keeps track of what memory address is the succedding instruction.  

Finally we are able to address the vulnerability being exploited, namely overwriting the pointed address.  
For example, in the priveous picture there is a buffer.  
The buffer was an allocated space for input from user to be contained.  
User exceeds the boundaries with its input and overflows into next address space, which overwrites the address.  
In extent, we have created a new pointed address which leads to seperate code being run and executed.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/BufferOverflowExplanation/CPU%20register.PNG" width="400" height="230">  
Ultimately, overwriting could lead to processes loading code which opens powershell and execute cmdlets.  

The general explanation of buffer overflow applies to both exploits used to gain access in this report.  
Link to Luigi Auriemma description, who was the first to report the vulnerability in Icecast.  
[Luigi Auriemma's report!](https://www.exploit-db.com/exploits/568)  

3.Attack  
========
Cybersecurity is a tug of war between attackers and defender.  
Both sides has respective weaknesses and strenghts and the element of surprise is perhaps the attackers foremost advantage.  
In the scenario at hand there are multiple possibilities for attackers to gain knowledge about the broadcasting service's network.  
The broadcasting service is a business and naturally advertise their services on the internet.  
Alternatively an attacker could also sweep through an entire ISP's IP adress block to find exposed computers.  
This is the auxilliary phase in which attackers gain knowledge prior to directly exploiting vulnerabilities.  

Reminder that all tools and methods explained are opensource and easily available for users without hacking background.  
3.1 Recon/Auxilliary  
--------------------
Nmap is a commonly used network mapping tool. There are numerous functionalities inside nmap which is used to discover hosts and affiliated services.  
Network packaged are sent and the returning answers, or lack of, are used to detemine which circumstances would produce similar answers.  
Furthermore, nmap generate reports based on percentage for possible conditions and environments the scanned host is in.  
in regards to retaining the element of surprise, attackers scan the target's network and gradually increasing the leverage.  
For example TCP packages are initially sent with SYN flagged which only completes half of the TCP handshake. Target will answer with reset as it has no knowledge of the connection and usually do not logg the occorunce.   
[Nmap-SYN-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-SynScan)  

It is notewhorty that routers and hosts usually are configured to not answer unestablished connections.  
The leverage of attack is increasing and "-A" option is flagged so nmap performs an aggressive scanning of the target.  
Experience attackers will refrain from using predefined scripts and methods, despite this our report illustrates that any user can be capable of launching such attacks.  
[Nmap-Agressive-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-AggressiveScan)  
[Nmap-Vulnerability-Scan](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/nmap-scans/nmap-VulnScan.PNG)  

Nmap reports that the target is likely vulnerable to ms-17_010, Namely the vulnerability EternalBlue used in WannaCry.  
In addition, nmap was also able to conclude that port 8000 is associated with Icecast services.  
At this point in time either exploit serves as an entry point, considering the radio broadcasting scenario the report will focus on exploiting Icecast.  

Metasploit is a framework to penetration test networks. For instance, Metasploit comes with nmap and a vast amount of modules to run against targets.  
The framework can be summarized with the following model provided by [Varonis blogg post](https://www.varonis.com/blog/what-is-metasploit/)  

<img src="https://blogvaronis2.wpengine.com/wp-content/uploads/2019/08/metasploit-guide-benefits.png" width="420" height="300">  


"Metasploit Icecast module  
Metasploit uses same script as first reported by [Luigi Auriemma](https://www.exploit-db.com/exploits/568) and is runnable after defining RHOST parameter to targeted host.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/IcecastExploitRun.PNG" width="620" height="150">  

Icecast script can be summarized into three stages:  
1. Use buffer overflow and point to malicious code.  
2. Malicious code installs Netcat or similar software on remote target, also create a listener awaiting connection from target.
3. Netcat establish TCP session with attacker from target.
4. Newly created session is established with meterpreter shell.  

Buffer overflow as explained previously is used to execute malicious code which installs Netcat.  
Netcat attemps to initiate TCP connection back to attacker, in our case the attacker has a listener awaiting on port 4444.  
Session is established and created with a meterpreter payload. Meterpreter is injected into the targets memory and serves the attacker as a "shell" which can load extensions from Metasploit.  
Meterpreter is out of scope of this report. Nevertheless, meterpreter residing in memory is important as nothing is written to disks and there is difficult to trace by defender.  


   
Metasploit 
[Metasploit-Logg](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Metasploit-Spool)  
   
   Icecast streaming media server





4.Recovery procedures 
=====================
Clients that host software services to the internet should be monitored carefully.
This topic covers procedures for recovering a system breached with the Icecast vulnerability.  

4.1 Identify the problem  
------------------------
Symptoms of a system breached through Icecast vulnerabilities can be found in:
1. Microsoft error message (pop up windows)
2. Microsoft Eventviewer
3. Netcat

Icecast will forcefully close on the client which is streaming.  
The generated pop upp error message describes Icecast encountering a problem.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/Icecast%20error%20message.PNG" width="400" height="230">  
host would need to be physically present to view such an error.  
Furthermore, there are small margins for the breach being reported before attacker has hidden his presence.  

Microsoft Eventviewer is far more likely to be noticed by defenders.  
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/Microsoft%20Eventviewer.PNG" width="300" height="300">  

Breached hosts can be recognized with traces of netcat.  
Netcat is shortly put a software able to establish network UDP and TCP connections.  
Signes of an attacker using this software is a capturing packets with the address of pages to download netcat.  
Another sign is physical instances of netcat listeners on host.  
For instance the process can be viewed through task manager and Eventviewer.  

4.2 Being rooted  
----------------
Contain the host and prefferably the whole network unavailable from internet. Involve law enforcement and document the actions that led to the compromised system being discovered.
Duplicate hard drives on exposed systems and assemble them together as evidence.  
Deliver the physical evidence in addition to all documentation of the accident to forensic analysis. It is vital that access to the evidence has been limited before changing custody.  

Ensuing reports in this scenario indicate that the attacker has gained admin or root privilege.  
Being rooted means the attacker is capable of planting backdoors to regain control at a later time, a full system recovery is necessary. 
In other words, achieving full certainy that a system is not under influence of others call for rebuilding at the operating system level.  


4.3 Recover control  
-------------------
The vulnerabilities explored in this report all stem from users having excessive rights and privileges.  
Restricting users and computers through group policies or other rule enforcing systems is advised.  
Administration of large enterprises and sophisticated networks are advised to follow the hereinafter ruleset:   
Foremost, vulnerabilities on the software itself require administration off allowed applications to run on hosts.  
Secondly, users should be prohibited from downloading software or limited to a secure selection.  
Internet access moderated through internal and external gateway's firewall.  
Antivirues software, keep in mind that not every virus is detectable or handable even by antivirus software. For example viruses have adapted to attack through staying in volatile memory which does not produce writing to files and is less detectable.  

4.4 Prospects of active directory
---------------------------------

    
    
Sources
=======
https://blogvaronis2.wpengine.com/wp-content/uploads/2019/08/metasploit-guide-benefits.png - Model for Metasploit


Appendix
========

[Powershell-ReportConvertedToHtml-Script](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/ScriptForRapport.ps1)  

[Powershell-HtmReportl-PDF](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/Html-Report.pdf)  
   
   
[Powershell-SendGitHubInfo-Script](https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Powershell%20Scripts%20%26%20Pictures/SendeGitLabScript.ps1) 
   
   
   
   #Creds all
   
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Creds_all.PNG" width="600" height="500">  
   
   
   
   #Escalating shell session 
   
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Escalating.PNG" width="650" height="290">  
   
   
   
   #Hashdump  
   
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/Metasploit/Hashdump.PNG" width="600" height="80">  
   
   
 
   
   
   #Screenshot  
   
<img src="https://github.com/nicholbs/TryHackMe/blob/master/LoggMapper/InfrastrukturSikreGrunntjenesterProsjekt/FinalReportOfExploit/ScreenshotOfTarget.jpeg" width="340" height="320">  

